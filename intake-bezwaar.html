<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bezwaar starten | ZekerOpWeg</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="fade-in">
  <section class="container" style="padding-top: 48px; padding-bottom: 80px;">
    <div class="contact-card">
      <h2>Bezwaar starten</h2>
      <p>Upload uw boete en wij starten automatisch uw juridische dossier.</p>

      <form id="bezwaarForm" novalidate>
        <div class="form-row" style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="form-group">
            <label>Naam</label>
            <input name="naam" required placeholder="Naam" autocomplete="name" />
          </div>

          <div class="form-group">
            <label>E mail</label>
            <input name="email" required placeholder="E mail" autocomplete="email" />
          </div>
        </div>

        <div class="form-row" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
          <div class="form-group">
            <label>Kenteken</label>
            <input name="kenteken" required placeholder="Kenteken" />
          </div>

          <div class="form-group">
            <label>Beschikkingsnummer</label>
            <input name="beschikking" required placeholder="Beschikkingsnummer" />
          </div>
        </div>

        <div class="form-row" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
          <div class="form-group">
            <label>Overtreding</label>
            <input name="type" required placeholder="Overtreding (bijv. parkeren)" />
          </div>

          <div class="form-group">
            <label>Abonnementscode</label>
            <input name="token" required placeholder="Abonnementscode" />
          </div>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label>Uw toelichting (optioneel)</label>
          <textarea name="toelichting" rows="6" placeholder="Uw toelichting"></textarea>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label>Upload boete (PDF of foto)</label>
          <input type="file" id="boeteFile" accept=".pdf,image/*" required />
          <small style="display:block; margin-top:6px; opacity:0.75;">
            Tip: maximaal 10 MB per upload
          </small>
        </div>

        <button id="submitBtn" type="submit" class="btn-primary" style="margin-top:18px;">
          Bezwaar starten
        </button>

        <div id="apiResult" style="margin-top:16px;"></div>
      </form>
    </div>
  </section>

  <script>
    // ‚úÖ Zet hier je actuele web app URL
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwJMnrWBwhh5bg-7EVRWpZKqVgGTO5rDi9xqI1VhyMGE75bL3RTm9HzhbD1kpmMXEkW6A/exec";

    const form = document.getElementById("bezwaarForm");
    const result = document.getElementById("apiResult");
    const btn = document.getElementById("submitBtn");
    const fileInput = document.getElementById("boeteFile");

    function esc(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function setStatus(html){
      result.innerHTML = html;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Basic validatie
      const fd = new FormData(form);
      const file = fileInput.files && fileInput.files[0];

      if (!file) {
        setStatus("‚ùå Selecteer een bestand.");
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        setStatus("‚ùå Bestand is te groot. Maximaal 10 MB.");
        return;
      }

      // UI state
      btn.disabled = true;
      btn.style.opacity = "0.7";
      setStatus("‚è≥ Dossier wordt aangemaakt...");

      try {
        // File ‚Üí base64
        const base64 = await new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result));
          r.onerror = reject;
          r.readAsDataURL(file);
        });

        // Payload bouwen
        const payload = {
          naam: String(fd.get("naam") || "").trim(),
          email: String(fd.get("email") || "").trim(),
          kenteken: String(fd.get("kenteken") || "").trim(),
          beschikking: String(fd.get("beschikking") || "").trim(),
          type: String(fd.get("type") || "").trim(),
          token: String(fd.get("token") || "").trim(),
          toelichting: String(fd.get("toelichting") || "").trim(),
          filename: file.name,
          mimetype: file.type || "application/octet-stream",
          filedata: base64.split(",")[1] // alleen base64, zonder prefix
        };

        // Extra harde validatie client side
        for (const k of ["naam","email","kenteken","beschikking","type","token"]) {
          if (!payload[k]) {
            throw new Error("Veld ontbreekt: " + k);
          }
        }

        // Timeout + fetch
        const controller = new AbortController();
        const timer = setTimeout(() => controller.abort(), 25000);

        const resp = await fetch(WEBAPP_URL, {
          method: "POST",
          // üî• Cruciaal: text/plain ‚Üí geen CORS preflight ‚Üí Apps Script werkt w√©l
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });

        clearTimeout(timer);

        const text = await resp.text();

        if (text.startsWith("OK|")) {
          const dossier = text.split("|")[1] || "";
          setStatus(
            "‚úÖ Dossier aangemaakt: <strong>" + esc(dossier) + "</strong><br>" +
            "U ontvangt een bevestiging per e mail zodra de intake is verwerkt."
          );
          form.reset();
        } else {
          setStatus("‚ùå " + esc(text));
        }

      } catch (err) {
        console.error(err);
        const msg = (err && err.name === "AbortError")
          ? "Timeout. De server reageert niet snel genoeg."
          : "Verbindingsfout. Check de web app toegang en logs.";
        setStatus("‚ùå " + esc(msg));
      } finally {
        btn.disabled = false;
        btn.style.opacity = "1";
      }
    });
  </script>
</body>
</html>


